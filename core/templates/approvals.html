{% extends "base.html" %}
{% load static %}

{% block title %}Approvals{% endblock %}
{% block mobile_title %}Approvals{% endblock %}

{% block extra_css %}
<style>
/* TikTok/YouTube Shorts style approvals */
.approvals-container {
  padding: 0;
  margin: 0;
  width: 100vw;
  height: 100vh;
  overflow: hidden;
  position: relative;
  background: #000;
}

.current-file-container {
  width: 100%;
  height: 100%;
  position: relative;
  display: flex;
  flex-direction: column;
}

/* File preview - takes most of the screen */
.file-preview-area {
  flex: 1;
  background: #000;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
}

.file-preview {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

.file-preview-icon {
  font-size: 120px;
  color: #666;
}

/* File info overlay */
.file-info-overlay {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: linear-gradient(transparent, rgba(0,0,0,0.8));
  color: white;
  padding: 20px;
  z-index: 10;
}

.file-title {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 8px;
  line-height: 1.3;
}

.file-meta {
  font-size: 14px;
  color: #ccc;
  margin-bottom: 12px;
}

.file-amount {
  font-size: 24px;
  font-weight: 700;
  color: #fff;
}

/* Bottom action area */
.action-area {
  background: white;
  padding: 20px;
  border-top: 1px solid #e5e7eb;
  min-height: 200px;
}

/* Class selection */
.class-selection {
  margin-bottom: 16px;
}

.class-selection-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  display: block;
  font-size: 14px;
}

.class-search-container {
  position: relative;
}

.class-search {
  width: 100%;
  padding: 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  background: white;
}

.class-search:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.class-dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  background: white;
  border: 1px solid #d1d5db;
  border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 150px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.class-option {
  padding: 12px;
  cursor: pointer;
  border-bottom: 1px solid #f3f4f6;
  font-size: 14px;
}

.class-option:hover {
  background: #f9fafb;
}

.class-option:last-child {
  border-bottom: none;
}

.selected-class {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 8px 12px;
  background: #eff6ff;
  border: 1px solid #3b82f6;
  border-radius: 6px;
  margin-top: 8px;
}

.selected-class-text {
  font-weight: 500;
  color: #1e40af;
  font-size: 14px;
}

.clear-class {
  background: none;
  border: none;
  color: #6b7280;
  font-size: 16px;
  cursor: pointer;
  padding: 0;
  width: 20px;
  height: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.clear-class:hover {
  background: #e5e7eb;
  color: #374151;
}

/* Comments */
.comments-section {
  margin-bottom: 16px;
}

.comments-label {
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
  display: block;
  font-size: 14px;
}

.comments-textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  resize: vertical;
  min-height: 60px;
  font-family: inherit;
}

/* Action buttons */
.action-buttons {
  display: flex;
  gap: 12px;
}

.action-btn {
  flex: 1;
  padding: 14px 16px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  min-height: 50px;
}

.action-btn.approve {
  background: #10b981;
  color: white;
}

.action-btn.approve:hover {
  background: #059669;
}

.action-btn.hold {
  background: #f59e0b;
  color: white;
}

.action-btn.hold:hover {
  background: #d97706;
}

.action-btn.reject {
  background: #ef4444;
  color: white;
}

.action-btn.reject:hover {
  background: #dc2626;
}

.action-btn.skip {
  background: #6b7280;
  color: white;
}

.action-btn.skip:hover {
  background: #4b5563;
}

/* Navigation buttons */
.nav-buttons {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  z-index: 20;
}

.nav-btn {
  position: absolute;
  background: rgba(0,0,0,0.5);
  color: white;
  border: none;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
}

.nav-btn:hover {
  background: rgba(0,0,0,0.7);
}

.nav-btn.prev {
  left: 20px;
}

.nav-btn.next {
  right: 20px;
}

/* File counter */
.file-counter {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(0,0,0,0.7);
  color: white;
  padding: 8px 12px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  z-index: 20;
}

/* Empty state */
.empty-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100vh;
  text-align: center;
  color: #6b7280;
  padding: 40px;
}

.empty-icon {
  font-size: 80px;
  margin-bottom: 20px;
}

.empty-title {
  font-size: 24px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 12px;
}

.empty-text {
  font-size: 16px;
  line-height: 1.5;
  max-width: 300px;
}

/* Messages */
.message {
  position: fixed;
  top: 80px;
  left: 16px;
  right: 16px;
  z-index: 1000;
  padding: 12px 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  font-size: 14px;
  font-weight: 500;
}

.message-success {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #a7f3d0;
}

.message-error {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fecaca;
}

.message-info {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}

/* Loading states */
.loading {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
  color: #6b7280;
}

.loading-spinner {
  width: 24px;
  height: 24px;
  border: 2px solid #e5e7eb;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-right: 12px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Desktop styles - make it more compact */
@media (min-width: 768px) {
  .approvals-container {
    max-width: 600px;
    margin: 0 auto;
    height: 100vh;
  }
  
  .action-area {
    min-height: 150px;
  }
  
  .file-preview-icon {
    font-size: 80px;
  }
  
  .file-title {
    font-size: 16px;
  }
  
  .file-amount {
    font-size: 20px;
  }
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="approvals-container">
  {% if pending_files %}
    <div class="file-counter">
      <span id="current-file-number">1</span> / <span id="total-files">{{ pending_files|length }}</span>
    </div>
    
    <!-- Navigation buttons -->
    <div class="nav-buttons">
      <button class="nav-btn prev" onclick="previousFile()" id="prev-btn" style="display: none;">‹</button>
      <button class="nav-btn next" onclick="nextFile()" id="next-btn">›</button>
    </div>
    
    <!-- Current file display -->
    <div class="current-file-container" id="current-file-container">
      <!-- File will be loaded here by JavaScript -->
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">✅</div>
      <div class="empty-title">All caught up!</div>
      <div class="empty-text">No files pending approval</div>
    </div>
  {% endif %}
</div>

<!-- Messages -->
{% if messages %}
  {% for message in messages %}
    <div class="message message-{{ message.tags }}">
      {{ message }}
    </div>
  {% endfor %}
{% endif %}

<script>
let files = {{ files_json|safe }};
let classes = {{ classes_json|safe }};
let currentFileIndex = 0;
let currentFileId = null;

// Debug logging and error handling
console.log('Files:', files);
console.log('Classes:', classes);

// Ensure files and classes are arrays
if (!Array.isArray(files)) {
  console.error('Files is not an array:', files);
  files = [];
}

if (!Array.isArray(classes)) {
  console.error('Classes is not an array:', classes);
  classes = [];
}

function loadCurrentFile() {
  if (files.length === 0) {
    document.querySelector('.approvals-container').innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">✅</div>
        <div class="empty-title">All caught up!</div>
        <div class="empty-text">No files pending approval</div>
      </div>
    `;
    return;
  }
  
  const file = files[currentFileIndex];
  currentFileId = file.id;
  
  // Update counter
  document.getElementById('current-file-number').textContent = currentFileIndex + 1;
  document.getElementById('total-files').textContent = files.length;
  
  // Update navigation buttons
  document.getElementById('prev-btn').style.display = currentFileIndex > 0 ? 'flex' : 'none';
  document.getElementById('next-btn').style.display = currentFileIndex < files.length - 1 ? 'flex' : 'none';
  
  // Create file preview
  let previewHtml = '';
  if (file.file_type === '.jpg' || file.file_type === '.jpeg' || file.file_type === '.png' || file.file_type === '.gif' || file.file_type === '.webp') {
    // For images, show the actual image
    if (file.file_url && file.file_url !== 'undefined' && file.file_url !== '') {
      previewHtml = `<img src="${file.file_url}" alt="File preview" class="file-preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">`;
    } else {
      previewHtml = '';
    }
  } else if (file.file_type === '.pdf') {
    // For PDFs, try to show the PDF using an iframe
    if (file.file_url && file.file_url !== 'undefined' && file.file_url !== '') {
      previewHtml = `
        <iframe src="${file.file_url}" class="file-preview" style="width: 100%; height: 100%; border: none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"></iframe>
      `;
    } else {
      previewHtml = '';
    }
  } else if (file.file_type === '.doc' || file.file_type === '.docx') {
    // For Word docs, try to show using Google Docs viewer
    if (file.file_url && file.file_url !== 'undefined' && file.file_url !== '') {
      previewHtml = `
        <iframe src="https://docs.google.com/gview?url=${encodeURIComponent(file.file_url)}&embedded=true" class="file-preview" style="width: 100%; height: 100%; border: none;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"></iframe>
      `;
    } else {
      previewHtml = '';
    }
  } else {
    // For other file types, show icon
    previewHtml = '';
  }
  
  // Add fallback icon for all file types
  const icon = file.file_type === '.pdf' ? '📄' : 
               (file.file_type === '.doc' || file.file_type === '.docx') ? '📝' : 
               (file.file_type === '.jpg' || file.file_type === '.jpeg' || file.file_type === '.png' || file.file_type === '.gif' || file.file_type === '.webp') ? '🖼️' : '📁';
  
  previewHtml += `<div class="file-preview-icon" style="display: ${previewHtml ? 'none' : 'flex'};">${icon}</div>`;
  
  // Add download button for files that can't be previewed
  if (file.file_type !== '.jpg' && file.file_type !== '.jpeg' && file.file_type !== '.png' && file.file_type !== '.gif' && file.file_type !== '.webp') {
    if (file.file_url && file.file_url !== 'undefined' && file.file_url !== '') {
      previewHtml += `
        <div style="position: absolute; bottom: 20px; right: 20px;">
          <button onclick="downloadFile('${file.file_url}', '${file.name}')" style="background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
            📥 Download
          </button>
        </div>
      `;
    }
  }
  
  // Create file info
  const fileInfoHtml = `
    <div class="file-info-overlay">
      <div class="file-title">${file.name}</div>
      <div class="file-meta">
        ${file.vendor || 'Unknown Vendor'} • ${file.project || 'No Project'} • ${file.uploaded_at ? new Date(file.uploaded_at).toLocaleDateString() : 'No Date'}
      </div>
      <div class="file-amount">${file.total || '$0.00'}</div>
    </div>
  `;
  
  // Create action area
  const actionAreaHtml = `
    <div class="action-area">
      <!-- Class Selection -->
      <div class="class-selection">
        <label class="class-selection-label" for="class-search-${file.id}">Select Class:</label>
        <div class="class-search-container">
          <input type="text" class="class-search" id="class-search-${file.id}" placeholder="Search for a class..." autocomplete="off">
          <div class="class-dropdown" id="class-dropdown-${file.id}" style="display: none;">
            <!-- Classes will be populated by JavaScript -->
          </div>
        </div>
        <div class="selected-class" id="selected-class-${file.id}" style="display: none;">
          <span class="selected-class-text"></span>
          <button type="button" class="clear-class" onclick="clearClassSelection(${file.id})">×</button>
        </div>
      </div>
      
        <!-- Comments -->
        <div class="comments-section">
          <label class="comments-label" for="approval-comment-${file.id}">Comments (required for Hold/Reject):</label>
          <textarea class="comments-textarea" id="approval-comment-${file.id}" placeholder="Required for Hold/Reject actions. Optional for Approve."></textarea>
        </div>
      
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn skip" onclick="skipFile(${file.id})">
          <span>⏭️</span>
          <span>Skip</span>
        </button>
        <button class="action-btn approve" onclick="approveFile(${file.id})">
          <span>✓</span>
          <span>Approve</span>
        </button>
        <button class="action-btn hold" onclick="holdFile(${file.id})">
          <span>◷</span>
          <span>Hold</span>
        </button>
        <button class="action-btn reject" onclick="rejectFile(${file.id})">
          <span>✗</span>
          <span>Reject</span>
        </button>
      </div>
    </div>
  `;
  
  // Update the container
  document.getElementById('current-file-container').innerHTML = `
    <div class="file-preview-area">
      ${previewHtml}
      ${fileInfoHtml}
    </div>
    ${actionAreaHtml}
  `;
  
  // Setup class search for this file
  setupClassSearch(file.id);
}

function nextFile() {
  if (currentFileIndex < files.length - 1) {
    currentFileIndex++;
    loadCurrentFile();
  }
}

function previousFile() {
  if (currentFileIndex > 0) {
    currentFileIndex--;
    loadCurrentFile();
  }
}

function approveFile(fileId) {
  const selectedClassId = document.getElementById(`selected-class-${fileId}`).dataset.classId;
  if (!selectedClassId) {
    showMessage('Please select a class', 'error');
    return;
  }
  
  const comment = document.getElementById(`approval-comment-${fileId}`).value;
  updateFileApproval(fileId, 'approved', comment, selectedClassId);
}

function holdFile(fileId) {
  const comment = document.getElementById(`approval-comment-${fileId}`).value;
  if (!comment.trim()) {
    showMessage('Please provide a comment explaining why this file is being held', 'error');
    return;
  }
  
  // For hold, we don't need a class selection
  updateFileApproval(fileId, 'hold', comment, null);
}

function rejectFile(fileId) {
  const comment = document.getElementById(`approval-comment-${fileId}`).value;
  if (!comment.trim()) {
    showMessage('Please provide a comment explaining why this file is being rejected', 'error');
    return;
  }
  
  // For reject, we don't need a class selection either
  updateFileApproval(fileId, 'rejected', comment, null);
}

function skipFile(fileId) {
  // Just move to next file without changing status
  if (currentFileIndex < files.length - 1) {
    currentFileIndex++;
    loadCurrentFile();
  } else {
    showMessage('No more files to review', 'info');
  }
}

function downloadFile(fileUrl, fileName) {
  // Create a temporary link to download the file
  const link = document.createElement('a');
  link.href = fileUrl;
  link.download = fileName;
  link.target = '_blank';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

function updateFileApproval(fileId, status, comment, classId) {
  const button = event.target;
  const originalText = button.innerHTML;
  
  // Show loading state
  button.innerHTML = '<span class="loading-spinner"></span>Processing...';
  button.disabled = true;
  
  fetch('{% url "update_file_approval" %}', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({
      file_id: fileId,
      approval_status: status,
      approval_comment: comment,
      selected_class_id: classId
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showMessage(data.message, 'success');
      
      // Remove the file from the array
      files = files.filter(f => f.id !== fileId);
      
      // If we're at the end, go back one
      if (currentFileIndex >= files.length) {
        currentFileIndex = Math.max(0, files.length - 1);
      }
      
      // Load next file
      loadCurrentFile();
    } else {
      showMessage(data.message, 'error');
    }
  })
  .catch(error => {
    showMessage('Error updating file approval', 'error');
  })
  .finally(() => {
    // Restore button state
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

function showMessage(message, type) {
  // Remove existing messages
  const existingMessages = document.querySelectorAll('.message');
  existingMessages.forEach(msg => msg.remove());
  
  // Create new message
  const messageDiv = document.createElement('div');
  messageDiv.className = `message message-${type}`;
  messageDiv.textContent = message;
  
  document.body.appendChild(messageDiv);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.remove();
    }
  }, 5000);
}

// Class search functionality
function setupClassSearch(fileId) {
  const searchInput = document.getElementById(`class-search-${fileId}`);
  const dropdown = document.getElementById(`class-dropdown-${fileId}`);
  const selectedClass = document.getElementById(`selected-class-${fileId}`);
  
  searchInput.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    if (query.length === 0) {
      dropdown.style.display = 'none';
      return;
    }
    
    const filteredClasses = classes.filter(cls => 
      cls.display_name.toLowerCase().includes(query)
    );
    
    if (filteredClasses.length === 0) {
      dropdown.innerHTML = '<div class="class-option">No classes found</div>';
    } else {
      dropdown.innerHTML = filteredClasses.map(cls => 
        `<div class="class-option" onclick="selectClass(${fileId}, ${cls.id}, '${cls.display_name}')">${cls.display_name}</div>`
      ).join('');
    }
    
    dropdown.style.display = 'block';
  });
  
  // Hide dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
}

function selectClass(fileId, classId, className) {
  const searchInput = document.getElementById(`class-search-${fileId}`);
  const dropdown = document.getElementById(`class-dropdown-${fileId}`);
  const selectedClass = document.getElementById(`selected-class-${fileId}`);
  
  // Hide search and dropdown
  searchInput.style.display = 'none';
  dropdown.style.display = 'none';
  
  // Show selected class
  selectedClass.style.display = 'flex';
  selectedClass.dataset.classId = classId;
  selectedClass.querySelector('.selected-class-text').textContent = className;
}

function clearClassSelection(fileId) {
  const searchInput = document.getElementById(`class-search-${fileId}`);
  const dropdown = document.getElementById(`class-dropdown-${fileId}`);
  const selectedClass = document.getElementById(`selected-class-${fileId}`);
  
  // Show search input
  searchInput.style.display = 'block';
  searchInput.value = '';
  
  // Hide selected class
  selectedClass.style.display = 'none';
  selectedClass.dataset.classId = '';
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if (e.key === 'ArrowLeft') {
    previousFile();
  } else if (e.key === 'ArrowRight') {
    nextFile();
  }
});

// Touch/swipe navigation
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener('touchstart', function(e) {
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener('touchend', function(e) {
  touchEndX = e.changedTouches[0].screenX;
  handleSwipe();
});

function handleSwipe() {
  const swipeThreshold = 50;
  const diff = touchStartX - touchEndX;
  
  if (Math.abs(diff) > swipeThreshold) {
    if (diff > 0) {
      // Swipe left - next file
      nextFile();
    } else {
      // Swipe right - previous file
      previousFile();
    }
  }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  if (files.length > 0) {
    loadCurrentFile();
  }
  
  // Add touch feedback
  const touchElements = document.querySelectorAll('.action-btn, .class-option, .nav-btn');
  touchElements.forEach(element => {
    element.addEventListener('touchstart', function() {
      this.style.transform = 'scale(0.98)';
    });
    
    element.addEventListener('touchend', function() {
      this.style.transform = '';
    });
  });
});
</script>
{% endblock %}